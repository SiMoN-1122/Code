/*********************************************************************************************************
* 模块名称：AD8233.c
* 摘    要：AD8233模块
* 当前版本：1.0.0
* 作    者：SZLY(COPYRIGHT 2018 - 2020 SZLY. All rights reserved.)
* 完成日期：2020年01月01日 
* 内    容：
* 注    意：                                                                  
**********************************************************************************************************
* 取代版本：
* 作    者：
* 完成日期：
* 修改内容：
* 修改文件：
*********************************************************************************************************/

/*********************************************************************************************************
*                                              包含头文件
*********************************************************************************************************/
#include "AD8233.h"
#include "gr55xx_hal.h"
#include "ADC.h"

/*********************************************************************************************************
*                                              宏定义
*********************************************************************************************************/
//ECG_NSDN：GPIO_24(GPIO1/GPIO_PIN_8),低电平进入低功率关机模式          输出
//ECG_VCC ：AON_GPIO_0,电源引脚                                               输出(可以不用)
//ECG_LOD ：AON_GPIO_2,导联检测引脚（应该连接时是低电平，确认一下）        输入
//ECG_OUT ：MSIO0，电压输入    （ADC）                                          ADC

/*********************************************************************************************************
*                                              枚举结构体定义
*********************************************************************************************************/

/*********************************************************************************************************
*                                              内部变量
*********************************************************************************************************/
int leadResult;
/*********************************************************************************************************
*                                              内部函数声明
*********************************************************************************************************/
static  void  ConfigAD8233GPIO(void);  //配置AD8233的GPIO

/*********************************************************************************************************
*                                              内部函数实现
*********************************************************************************************************/
/*********************************************************************************************************
* 函数名称：ConfigAD8233GPIO
* 函数功能：配置AD8233的GPIO 
* 输入参数：void 
* 输出参数：void
* 返 回 值：void
* 创建日期：2018年01月01日
* 注    意：
*********************************************************************************************************/
static  void  ConfigAD8233GPIO(void)
{
  gpio_init_t gpio_config = GPIO_DEFAULT_CONFIG;
  aon_gpio_init_t aon_gpio_config = GPIO_DEFAULT_CONFIG;
  
  //ECG_NSDN
  gpio_config.mode = GPIO_MODE_OUTPUT;  
  gpio_config.pin  = GPIO_PIN_8;
  hal_gpio_init(GPIO1, &gpio_config);
  
  hal_gpio_write_pin(GPIO1, GPIO_PIN_8, GPIO_PIN_SET); // 高电平进入正常模式
  
//  //ECG_VCC
//  aon_gpio_config.mode = AON_GPIO_MODE_OUTPUT;
//  aon_gpio_config.pin  = AON_GPIO_PIN_0;
//  hal_aon_gpio_init(&aon_gpio_config);
//  
//  hal_aon_gpio_write_pin(AON_GPIO_PIN_1,AON_GPIO_PIN_SET);  // 供电正常运行
  
  
  //ECG_LOD
  aon_gpio_config.mode = AON_GPIO_MODE_INPUT;
  aon_gpio_config.pin  = AON_GPIO_PIN_2;
  aon_gpio_config.pull = AON_GPIO_PULLUP;
  hal_aon_gpio_init(&aon_gpio_config); 

}

/*********************************************************************************************************
*                                              API函数实现
*********************************************************************************************************/
/*********************************************************************************************************
* 函数名称：InitAD8233
* 函数功能：初始化AD8233模块
* 输入参数：void
* 输出参数：void
* 返 回 值：void
* 创建日期：2018年01月01日
* 注    意：
*********************************************************************************************************/
void InitAD8233(void)
{
  ConfigAD8233GPIO();  //配置AD8233的GPIO
  InitADC(ECG_CHANNEL);
  leadResult = 0;     //未导联
}

/*********************************************************************************************************
* 函数名称：LeadDetect
* 函数功能：进行常规的导联检测
* 输入参数：void
* 输出参数：void
* 返 回 值：void
* 创建日期：2018年01月01日
* 注    意：该函数应定时调用，目前在2ms，设置超过25次内检测到导联则设置状态为导联，不导联同理
*********************************************************************************************************/
void LeadDetect(void)
{
  static int leadon = 0;
  static int leadoff = 0;
  
  //导联检测（别引入工频干扰，不然会一直误检测）
  if(ECG_LOD)
  {
    leadoff >= 25? leadResult = 0:leadoff++;
    leadon = 0;
  }
  else
  {
    leadon >= 25?  leadResult = 1:leadon++;
    leadoff = 0;
  }
  
}
